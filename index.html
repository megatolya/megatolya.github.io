<!DOCTYPE html>
<html>
<head>
    <title>Player</title>

    <style type="text/css">
    html, body {
        background: #000;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    object {
        height: 100%;
        position: absolute;
        width: 100%;
    }

    embed {
        height: 100%;
        width: 100%;
    }

    iframe {
        visibility: hidden;
        width: 0;
        height: 0;
    }
    </style>
</head>
<body>
    <div id="player"></div>

    <script type="text/javascript" charset="utf-8" src="//yastatic.net/jquery/1.11.2/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="//yastatic.net/swfobject/2.1/swfobject.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="http://tolya.me/local-connection.js"></script>

    <script type="text/javascript">
    function onSite() {
        return true;
    }

    (function () {
        console.log('hello from player');
        'use strict';

        var isPopup = (Boolean(window.opener) && window.name === 'kinopoisk-popup');
        var transportWindow = isPopup ? window.opener : window.parent;
        var isDebug = false;

        var POPUP_WIDTH = 1000;
        var POPUP_HEIGHT = 500;
        var POPUP_LEFT = Math.max(((screen.availWidth - POPUP_WIDTH) / 2), 0);
        var POPUP_TOP = Math.max(((screen.availHeight - POPUP_HEIGHT) / 2), 0);

        if (isPopup) {
            window.resizeTo(POPUP_WIDTH, POPUP_HEIGHT);
            window.moveTo(POPUP_LEFT, POPUP_TOP);
        }

        function debug(level) {
            if (isDebug && 'console' in window) {
                var args = Array.prototype.slice.call(arguments, 1);
                args[0] = '[player] ' + args[0];

                console[level].apply(console, args);
            }
        }

        function emit(msg) {
            transportWindow.postMessage(msg, '*');
        }

        function requestPlayerVersion(useLatestPlayer) {
            var deferred = $.Deferred();

            if (useLatestPlayer) {
                deferred.resolve('//betastatic.kp.yandex.net/swf/cinemaplayer/13_102/v-1/cinemaplayer.swf');
            } else {
                var jsonpPlayerInfo = '//static.kp.yandex.net/swf/cinemaplayer/13_102/info';
                var playerURL = '//static.kp.yandex.net/swf/cinemaplayer/13_102/v-{version}/cinemaplayer.swf';
                var defaultPlayerURL = playerURL.replace('{version}', '1');

                // @see http://stackoverflow.com/questions/19035557/jsonp-request-error-handling
                var jsonpTimeoutId = setTimeout(function () {
                    deferred.resolve(defaultPlayerURL);
                }, 3000);

                $.ajax({
                    url: jsonpPlayerInfo,
                    dataType: 'jsonp',
                    jsonp: false,
                    jsonpCallback: 'getInfo',
                    success: function (res) {
                        clearTimeout(jsonpTimeoutId);

                        playerURL = playerURL.replace('{version}', '$' + res.version);
                        deferred.resolve(playerURL);
                    },
                    error: function () {
                        deferred.resolve(defaultPlayerURL);
                    }
                });
            }

            return deferred;
        }

        function embedPlayer(playerURL, flashVars) {
            var params = {
                allowScriptAccess: 'always',
                allowfullscreen: 'true',
                hasPriority: 'true',
                wmode: 'window'
            };

            flashVars.onReady = 'FlashAPI.onPlayerReady';
            flashVars.onStateChange = 'FlashAPI.onStateChange';
            flashVars.onAdStateChange = 'FlashAPI.onAdStateChange';
            flashVars.onEpisodeChange = 'FlashAPI.onEpisodeChange';

            var hidden = ['rotate', 'share'];
            if (isPopup) {
                hidden.push('close');
            }
            flashVars.hidden = hidden.join(',');

            // https://st.yandex-team.ru/KINOFRONT-3459
            // http://codeblow.com/questions/strange-opera-swfobject-display-problem/
            //swfobject.switchOffAutoHideShow();

            console.log('before embedSWF');
            swfobject.embedSWF('http:' + playerURL, 'player', 900, 500, '10.0.0', null, flashVars, params);
            console.log(playerURL);
            //swfobject.embedSWF('http://www.w3schools.com/tags/helloworld.swf', 'player', 100, 100, '10.0.0', null);
            console.log('after embedSWF');
        }

        function changePlayingState() {
            var player = $('#player').get(0);

            if (player.getPlayerState() === 'play') {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function pauseVideo() {
            var player = $('#player').get(0);
            player.pauseVideo();
        }

        // parse GET params
        var search = location.search.replace(/^\?/, '').split('&');
        var query = {};

        search.forEach(function (part) {
            part = part.split('=', 2).map(decodeURIComponent);
            query[part[0]] = part[1];
        });

        isDebug = (query.debug !== undefined);

        // where will be flashapi.js loaded from
        var baseorigin = 'http://beta.kinopoisk.ru';
        if (query.baseorigin) {
            if (/\.kinopoisk\.ru(:[\d]+)?$/.test(query.baseorigin)) {
                baseorigin = query.baseorigin;
            } else {
                debug('warn', 'baseorigin param is not valid: %s', query.baseorigin);
            }
        } else {
            debug('warn', 'baseorigin param is not specified. Loading FlashAPI from beta.kinopoisk.ru');
        }

        // which host should we listen to requests from
        var useLatestPlayer = (query.latest !== undefined);

        // baseorigin should be available inside FlashAPI
        window.baseorigin = baseorigin;

        var flashapiLoaded = $.Deferred();
        var scriptElem = document.createElement('script');
        scriptElem.src = baseorigin + '/cinemaplayer/flashapi.js';
        scriptElem.type = 'text/javascript';

        // unfortunately this doesn't work in IE8
        // @see https://msdn.microsoft.com/en-us/library/hh180173(v=vs.85).aspx
        scriptElem.onload = function () {
            debug('log', 'FlashAPI loaded');
            flashapiLoaded.resolve();
        };

        document.body.appendChild(scriptElem);

        $.when(requestPlayerVersion(useLatestPlayer), flashapiLoaded).done(function (playerURL) {
            function handleAction(evtData) {
                switch (evtData.action) {
                    case 'show-player':
                        alert('show-player');
                        clearTimeout(localConnectionTransportTimeout);
                        embedPlayer(playerURL, evtData.flashVars);
                        try {
                            history.replaceState(null, evtData.title, document.location.href);
                        } catch (ex) {}
                        document.querySelector('title').innerHTML = evtData.title;
                        alert('success');
                        break;

                    case 'keydown-space':
                        if (!isPopup) {
                            changePlayingState();
                        }

                        break;

                    case 'video-pause':
                        if (!isPopup) {
                            pauseVideo();
                        }

                        break;
                }
            }

            debug('log', 'URL used: %s', playerURL);
            //emit({type: 'player-prerequisites-loaded'});

            if (isPopup) {
                debug('log', 'using popup mode');
            } else {
                debug('log', 'using iframe mode');
            }

            $(window).on('message', function onMessageReceive(evt) {
                debug('log', 'message received: %o', evt.originalEvent);

                if (evt.originalEvent.origin !== baseorigin) {
                    debug('warn', 'origin mismatch: expected %s, got %s', baseorigin, evt.originalEvent.origin);
                    return;
                }

                var originalEvt = evt.originalEvent;
                var evtData = originalEvt.data;

                debug('log', 'processing message: %o', evtData);

                handleAction(evtData);
            });

            var localConnectionTransportTimeout = setTimeout(function localConnectionTransportCallback() {
                // fallback to communication with iframe/localconnection for ie10/11
                debug('log', 'fallback to localConneciton transport...');

                function emit(data) {
                    window.getLocalConnection('popup', 'main').emit('movieData', data);
                }

                window.addEventListener('message', function (evt) {
                    emit(evt.data);
                });

                emit({type: 'player-prerequisites-loaded', transport: 'localConnection'});
                getLocalConnection('popup', 'main').on('movieData', function (data) {
                    console.log('getLocalConnection!');
                    alert('movieData ' + JSON.stringify(data));
                    handleAction(data);
                });
            }, 1000);
        });
    })();
    </script>
</body>
</html>
